export module viu.version;

import std;

namespace viu::version {

template <typename T>
concept version_info = requires {
    { T::major } -> std::convertible_to<std::uint32_t>;
    { T::minor } -> std::convertible_to<std::uint32_t>;
    { T::patch } -> std::convertible_to<std::uint32_t>;
    { T::pre_release } -> std::convertible_to<std::string_view>;
    { T::git_commit } -> std::convertible_to<std::string_view>;
};

template <version_info T>
std::string make_full()
{
    std::string version;

    version.append(std::to_string(T::major))
        .append(".")
        .append(std::to_string(T::minor))
        .append(".")
        .append(std::to_string(T::patch));

    if (!T::pre_release.empty()) {
        version.append("-").append(T::pre_release);
    }

    if (!T::git_commit.empty()) {
        version.append("+").append(T::git_commit);
    }

    return version;
}

export struct app {
    static constexpr std::uint32_t major = @APP_MAJOR_VERSION@;
    static constexpr std::uint32_t minor = @APP_MINOR_VERSION@;
    static constexpr std::uint32_t patch = @APP_PATCH_VERSION@;

    static constexpr std::string_view pre_release = "@APP_PRE_RELEASE_VERSION@";
    static constexpr std::string_view git_commit = "@GIT_COMMIT@";

    static std::string full() { return make_full<app>(); }
};

export struct lib {
    static constexpr std::uint32_t major = @LIB_MAJOR_VERSION@;
    static constexpr std::uint32_t minor = @LIB_MINOR_VERSION@;
    static constexpr std::uint32_t patch = @LIB_PATCH_VERSION@;

    static constexpr std::string_view pre_release = "@LIB_PRE_RELEASE_VERSION@";
    static constexpr std::string_view git_commit = "@GIT_COMMIT@";

    static std::string full() { return make_full<lib>(); }
};

} // namespace viu::version
